<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inspection & Work Report App</title>
    
    <link rel="manifest" href="manifest.json">
    
    <meta name="theme-color" content="#3B82F6">

    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <link id="favicon" rel="icon" href="https://thebayservices.com/wp-content/uploads/2022/07/bay-services-logo.png" type="image/png">
    <script src="https://cdn.tailwindcss.com" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; 
        }
        .form-group {
            margin-bottom: 1rem; 
        }
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151; 
        }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #D1D5DB; 
            border-radius: 0.375rem; 
            box-shadow: inset 0 1px 2px 0 rgba(0,0,0,0.05);
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #3B82F6; 
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
            text-align: center; 
        }
        .btn-primary {
            background-color: #3B82F6; color: white;
        }
        .btn-primary:hover {
            background-color: #2563EB; 
        }
        .btn-secondary {
            background-color: #6B7280; color: white;
        }
        .btn-secondary:hover {
            background-color: #4B5563; 
        }
        .btn-success {
            background-color: #10B981; color: white;
        }
        .btn-success:hover {
            background-color: #059669; 
        }
        .photo-upload-area { 
            display: block; 
            border: 2px dashed #3498db; 
            padding: 1.5rem; 
            text-align: center;
            cursor: pointer;
            border-radius: 0.5rem; 
            background-color: #f8fafc; 
        }
        .photo-upload-area:hover {
            border-color: #2980b9; 
            background-color: #eff6ff; 
        }
        .photo-item {
            position: relative; display: inline-block; margin: 0.5rem;
            border: 1px solid #e5e7eb; border-radius: 0.375rem; overflow: hidden;
            width: 100px; 
            height: 100px; 
            display: flex; 
            align-items: center;
            justify-content: center;
            background-color: #f9fafb; 
        }
        .photo-item img {
            max-width: 100%; 
            max-height: 100%; 
            object-fit: cover;
        }
        .photo-remove {
            position: absolute; top: 5px; right: 5px;
            background-color: rgba(0,0,0,0.6); color: white;
            border: none; border-radius: 50%;
            width: 24px; height: 24px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 0.8rem;
        }
        .photo-remove:hover {
            background-color: rgba(239, 68, 68, 0.8); 
        }
        .modal {
            display: none; position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            overflow-y: auto; 
            background-color: rgba(0,0,0,0.6);
        }
        .modal-content {
            background-color: #fff; margin: 5% auto; padding: 20px; 
            border: 1px solid #ccc; width: 90%; max-width: 800px; 
            border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative; 
        }
        .modal-body { 
             max-height: 75vh; 
             overflow-y: auto;
        }
        .close {
            position: absolute; top: 10px; right: 15px;
            color: #aaa; font-size: 28px; font-weight: bold;
            cursor: pointer; z-index: 1001;
        }
        .close:hover, .close:focus {
            color: #333;
        }
        .report-content img.report-logo-preview { 
            max-width: 150px; 
            height: auto; 
            margin-bottom: 1rem;
            border: none; 
        }
        .report-content img { 
            max-width: 150px; 
            height: auto; margin: 5px; border: 1px solid #ddd;
            border-radius: 4px; display: inline-block; 
        }
        .report-title {
            font-size: 1.5em; font-weight: bold; margin-bottom: 0.5rem;
            color: #1F2937; 
        }
         .report-phase-title { 
            font-size: 1.3em; font-weight: bold; margin-top: 1.5rem; margin-bottom: 0.75rem;
            color: #1e40af; 
            border-bottom: 2px solid #93c5fd; 
            padding-bottom: 0.25rem;
        }
        .report-header {
            text-align: center; margin-bottom: 1rem; 
            border-bottom: 2px solid #e5e7eb; 
            padding-bottom: 1rem;
        }
        .report-section {
            margin-bottom: 1.5rem;
        }
        .report-section h3 { 
            font-size: 1.1em; 
            font-weight: 600;
            color: #3B82F6; 
            margin-bottom: 0.5rem; 
            border-bottom: 1px solid #DBEAFE; 
            padding-bottom: 0.25rem;
        }
        .report-photos {
            display: flex; flex-wrap: wrap; gap: 10px; 
            justify-content: flex-start; 
        }
        .address-suggestions {
            border: 1px solid #D1D5DB; border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
            max-height: 200px; overflow-y: auto;
            background-color: white; position: absolute;
            width: calc(100% - 2px); 
            z-index: 10;
        }
        .address-suggestion {
            padding: 0.75rem; cursor: pointer;
        }
        .address-suggestion:hover {
            background-color: #F3F4F6; 
        }
        #messageBox {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        .checkbox-label {
            display: flex; align-items: center; margin-bottom: 0.5rem;
            cursor: pointer;
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        @media (max-width: 640px) { 
            .modal-content {
                margin: 2.5% auto; padding: 15px; width: 95%;
            }
            .report-title { font-size: 1.3em; }
            .report-phase-title { font-size: 1.15em; }
            .report-section h3 { font-size: 1.0em; }
            .btn {
                width: 100%; margin-bottom: 0.5rem; 
            }
            .flex.sm\\:flex-row { 
                 flex-direction: column;
            }
            .flex.sm\\:flex-row > .btn:not(:last-child) {
                margin-right: 0; 
            }
        }
    </style>
</head>
<body class="p-2 sm:p-4 md:p-8">
    <div id="javascript-running-indicator" style="background-color: lightgreen; padding: 5px; text-align: center; display: none;">JavaScript is running!</div>
    <div id="messageBox" class="fixed top-5 right-5 text-white p-4 rounded-lg shadow-xl z-50 hidden opacity-0 transform translate-y-[-20px]"></div>

    <div class="container mx-auto max-w-4xl bg-white p-4 sm:p-6 md:p-8 rounded-xl shadow-2xl">
        <div class="text-center mb-6 sm:mb-8">
            <img id="headerLogo" src="https://thebayservices.com/wp-content/uploads/2022/07/bay-services-logo.png" alt="Bay Services Logo" class="mx-auto h-12 sm:h-16 w-auto mb-3 sm:mb-4" onerror="this.style.display='none'; console.error('Failed to load header logo from URL. It will be hidden.')">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Inspection & Work Report</h1>
            <p class="text-sm sm:text-base text-gray-600">Fill out the inspection and work details below.</p>
            <p class="text-xs sm:text-sm text-gray-500 mt-2">User ID: <span id="userIdDisplay">Loading...</span></p>
        </div>

        <form id="inspectionForm" class="space-y-6">
            <fieldset class="border p-3 sm:p-4 rounded-md">
                <legend class="text-lg font-semibold text-gray-700 px-2">Customer & Service Setup</legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                    <div class="form-group">
                        <label for="customerName" class="form-label">Customer Name <span class="text-red-500">*</span></label>
                        <input type="text" id="customerName" class="form-input" required autocomplete="name">
                    </div>
                    <div class="form-group">
                        <label for="phoneNumber" class="form-label">Phone Number</label>
                        <input type="tel" id="phoneNumber" class="form-input" autocomplete="tel">
                    </div>
                    <div class="form-group md:col-span-2">
                        <label for="email" class="form-label">Email Address</label>
                        <input type="email" id="email" class="form-input" autocomplete="email">
                    </div>
                    <div class="form-group relative md:col-span-2"> 
                        <label for="address" class="form-label">Service Address <span class="text-red-500">*</span></label>
                        <input type="text" id="address" class="form-input" required autocomplete="street-address">
                        <div id="addressSuggestions" class="address-suggestions hidden"></div>
                    </div>
                     <div class="form-group">
                        <label for="serviceDate" class="form-label">Service Date <span class="text-red-500">*</span></label>
                        <input type="date" id="serviceDate" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="serviceType" class="form-label">Service Type</label>
                        <select id="serviceType" class="form-select">
                            <option value="Air Duct Cleaning">Air Duct Cleaning</option>
                            <option value="Dryer Vent Cleaning SIDE-BY-SIDE">Dryer Vent Cleaning SIDE-BY-SIDE</option>
                            <option value="Chimney Sweep">Chimney Sweep</option>
                            <option value="Furnace Cleaning with Blower">Furnace Cleaning with Blower</option>
                            <option value="Kitchen Range Hood Cleaning">Kitchen Range Hood Cleaning</option>
                            <option value="Dryer Vent Cleaning STACKED">Dryer Vent Cleaning STACKED</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="technician" class="form-label">Technician Name</label>
                        <select id="technician" class="form-select">
                            <option value="">Select Technician</option>
                            <option value="Alex">Alex</option>
                            <option value="Riz">Riz</option>
                            <option value="Vusal">Vusal</option>
                            <option value="Orkhan">Orkhan</option>
                            <option value="Vance">Vance</option>
                        </select>
                    </div>
                </div>
            </fieldset>

            <fieldset class="border p-3 sm:p-4 rounded-md">
                <legend class="text-xl font-bold text-blue-700 px-2">Phase 1: Pre-Service Inspection Report</legend>
                <div class="form-group mt-4">
                    <label for="preInspectionNotes" class="form-label">Initial Observations & Findings</label>
                    <div id="preInspectionChecklist" class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 mb-4">
                        <!-- Dynamic checklist will be populated here -->
                    </div>
                    <div class="mt-4">
                        <label for="otherObservations" class="form-label">Other observations (please specify):</label>
                        <textarea id="otherObservations" class="form-textarea" rows="2" placeholder="Enter any additional observations..."></textarea>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Inspection Photos (Before Service)</label>
                    <label for="photoInputInspection" id="photoUploadInspection" class="photo-upload-area mb-4">
                        <i class="fas fa-camera-retro text-3xl sm:text-4xl text-blue-500 mb-2"></i>
                        <p class="text-sm sm:text-base">Upload Inspection Photos</p>
                    </label>
                    <input type="file" id="photoInputInspection" multiple accept="image/*" class="sr-only">
                    <div id="photoPreviewInspection" class="mt-4 grid grid-cols-2 xs:grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-2 sm:gap-4">
                    </div>
                </div>
            </fieldset>
            
            <fieldset class="border p-3 sm:p-4 rounded-md">
                <legend class="text-xl font-bold text-green-700 px-2">Phase 2: Work Done & Recommendations Report</legend>
                <div class="form-group mt-4">
                    <label class="form-label">Work Performed Checklist</label>
                    <div id="workPerformedChecklist" class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 mb-4">
                        <!-- Dynamic checklist will be populated here -->
                    </div>
                    <div class="mt-4">
                        <label for="otherWorkPerformed" class="form-label">Other work performed (specify):</label>
                        <textarea id="otherWorkPerformed" class="form-textarea" rows="2" placeholder="Enter any additional work performed..."></textarea>
                    </div>
                </div>

                <div class="form-group">
                    <label for="workPerformed" class="form-label">Additional Work Performed Details</label>
                    <textarea id="workPerformed" class="form-textarea" rows="4" placeholder="Describe any additional tasks, repairs, or specific details about the work done."></textarea>
                </div>
                <div class="form-group">
                    <label for="recommendations" class="form-label">Recommendations for Customer</label>
                    <textarea id="recommendations" class="form-textarea" rows="4" placeholder="Suggest any follow-up actions, future maintenance, or improvements."></textarea>
                </div>
                 <div class="form-group">
                    <label class="form-label">Work Done Photos (After Service)</label>
                    <label for="photoInputWorkDone" id="photoUploadWorkDone" class="photo-upload-area mb-4">
                        <i class="fas fa-tools text-3xl sm:text-4xl text-green-500 mb-2"></i>
                        <p class="text-sm sm:text-base">Upload Work Done Photos</p>
                    </label>
                    <input type="file" id="photoInputWorkDone" multiple accept="image/*" class="sr-only">
                    <div id="photoPreviewWorkDone" class="mt-4 grid grid-cols-2 xs:grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-2 sm:gap-4">
                    </div>
                </div>
            </fieldset>

            <div class="flex flex-col sm:flex-row justify-end space-y-3 sm:space-y-0 sm:space-x-3 mt-6 sm:mt-8">
                <button type="button" id="saveBtn" class="btn btn-primary w-full sm:w-auto"><i class="fas fa-save mr-2"></i>Save Data</button>
                <button type="button" id="previewBtn" class="btn btn-secondary w-full sm:w-auto"><i class="fas fa-eye mr-2"></i>Preview Report</button>
                <button type="button" id="generatePdfBtn" class="btn btn-success w-full sm:w-auto"><i class="fas fa-file-pdf mr-2"></i>Generate PDF</button>
            </div>
        </form>
    </div>

    <div id="reportModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="modal-body" id="reportPreview"> 
            </div>
        </div>
    </div>

    <script type="module">
        // --- Global Error Handler ---
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("Global error caught:", { message, source, lineno, colno, errorObj: error });
            const displayMessage = `Critical Error: ${message} (line ${lineno}). Check console.`;
            if (typeof showMessage === 'function' && document.getElementById('messageBox')) { 
                showMessage(displayMessage, 'error');
            } else {
                let alertMsg = `CRITICAL ERROR: ${message} (Source: ${source}, Line: ${lineno}). App may not work. Please check browser console.`;
                if (error && error.message) {
                    alertMsg += ` Details: ${String(error.message)}`; 
                }
                alert(alertMsg);
            }
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = (typeof __app_id !== 'undefined') ? __app_id : 'duct-inspection-app-default';
        const firebaseConfig = (typeof __firebase_config !== 'undefined') ? JSON.parse(__firebase_config) : {
            apiKey: "YOUR_API_KEY", 
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        const initialAuthToken = (typeof __initial_auth_token !== 'undefined') ? __initial_auth_token : null;

        let firebaseApp;
        let auth;
        let db;
        try {
            firebaseApp = initializeApp(firebaseConfig);
            auth = getAuth(firebaseApp);
            db = getFirestore(firebaseApp);
            // setLogLevel('debug'); 
            console.log("Firebase initialized successfully.");
        } catch (e) {
            console.error("Firebase initialization error object:", e); 
            let alertMsg = "CRITICAL: Firebase initialization failed. App may not work correctly. Check console.";
            if (e && e.message) {
                alertMsg += ` Details: ${String(e.message)}`; 
            }
            alert(alertMsg);
        }

        let currentUserId = null;
        let appInstance = null; 

        function showMessage(message, type = 'info') {
            const messageBox = document.getElementById('messageBox');
            if (!messageBox) { 
                console.warn("showMessage called before messageBox is available. Message:", message);
                alert(`Notification (${type}): ${message}`); 
                return;
            }
            messageBox.textContent = message;
            const baseClasses = 'fixed top-5 right-5 text-white p-4 rounded-lg shadow-xl z-50';
            const typeClasses = { info: 'bg-blue-500', success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500 text-black' };
            messageBox.className = `${baseClasses} ${typeClasses[type] || typeClasses.info}`;
            messageBox.classList.remove('hidden', 'opacity-0', 'translate-y-[-20px]');
            messageBox.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => {
                messageBox.classList.remove('opacity-100', 'translate-y-0');
                messageBox.classList.add('opacity-0', 'translate-y-[-20px]');
                setTimeout(() => messageBox.classList.add('hidden'), 500); 
            }, type === 'error' ? 7000 : 3000); 
        }

        async function attemptSignIn() {
            console.log("Attempting initial sign-in...");
            if (!auth) {
                console.error("attemptSignIn: Firebase Auth not initialized. Cannot proceed.");
                showMessage('Authentication system not ready. Please refresh.', 'error');
                return;
            }
            try {
                if (auth.currentUser) {
                    console.log("User already signed in:", auth.currentUser.uid);
                    return; 
                }

                if (initialAuthToken) {
                    console.log("Attempting sign-in with custom token.");
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Successfully signed in with custom token.");
                } else {
                    console.log("No initialAuthToken, attempting anonymous sign-in.");
                    await signInAnonymously(auth);
                    console.log("Successfully signed in anonymously.");
                }
            } catch (error) {
                 console.error("Error during sign-in attempt (custom token or anonymous):", error);
            }
        }
        
        if (auth) { 
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    console.log("Auth state changed: User signed in - ", currentUserId);
                    const userIdDisplay = document.getElementById('userIdDisplay');
                    if (userIdDisplay) userIdDisplay.textContent = currentUserId;
                    
                    if (!appInstance && db) { 
                        console.log("User authenticated, appInstance not yet created (onAuthStateChanged). Creating now.");
                        appInstance = new DuctInspectionApp(db);
                        appInstance.init(); 
                    }

                    if (appInstance && typeof appInstance.loadSavedData === 'function') { 
                        console.log("User authenticated, calling loadSavedData.");
                        appInstance.loadSavedData();
                    } else {
                        console.warn("onAuthStateChanged: appInstance or loadSavedData not ready, or db not available when user authenticated.");
                    }
                } else {
                    currentUserId = null; 
                    console.log("Auth state changed: User signed out or no user yet established by attemptSignIn.");
                    const userIdDisplay = document.getElementById('userIdDisplay');
                    if (userIdDisplay) userIdDisplay.textContent = "Not authenticated";
                }
            });
        } else {
            console.error("Firebase Auth object is not available. Authentication will not work.");
            if (typeof showMessage === 'function' && document.getElementById('messageBox')) {
                 showMessage("Firebase Auth could not be initialized. App functions requiring login will fail.", "error");
            } else {
                alert("CRITICAL: Firebase Auth object not initialized. Login features disabled.");
            }
        }

        class DuctInspectionApp {
            constructor(firestoreDb) {
                console.log("DuctInspectionApp constructor called.");
                if (!firestoreDb) {
                    console.error("Firestore DB instance is not provided to DuctInspectionApp constructor!");
                    alert("CRITICAL: Database connection not available for the app. Functionality will be limited.");
                }
                this.db = firestoreDb; 
                this.inspectionPhotos = []; 
                this.workDonePhotos = [];   
            }

            init() {
                console.log("DuctInspectionApp init() called.");
                this.setupEventListeners();
                this.setDefaultDate();
            }

            setupEventListeners() {
                console.log("Setting up event listeners...");
                const photoInputInspection = document.getElementById('photoInputInspection');
                if(photoInputInspection) {
                    photoInputInspection.addEventListener('change', (e) => this.handlePhotoUpload('inspection', e));
                } else { console.error("photoInputInspection not found!"); }

                const photoInputWorkDone = document.getElementById('photoInputWorkDone');
                if(photoInputWorkDone) {
                     photoInputWorkDone.addEventListener('change', (e) => this.handlePhotoUpload('workDone', e));
                } else { console.error("photoInputWorkDone not found!"); }
                
                const photoUploadInspectionLabel = document.getElementById('photoUploadInspection'); 
                if(photoUploadInspectionLabel) {
                    photoUploadInspectionLabel.addEventListener('dragover', (e) => { e.preventDefault(); photoUploadInspectionLabel.style.borderColor = '#2980b9'; photoUploadInspectionLabel.classList.add('bg-blue-100'); });
                    photoUploadInspectionLabel.addEventListener('dragleave', () => { photoUploadInspectionLabel.style.borderColor = '#3498db'; photoUploadInspectionLabel.classList.remove('bg-blue-100'); });
                    photoUploadInspectionLabel.addEventListener('drop', (e) => { e.preventDefault(); photoUploadInspectionLabel.style.borderColor = '#3498db'; photoUploadInspectionLabel.classList.remove('bg-blue-100'); this.handlePhotoUpload('inspection', e); });
                } else { console.error("photoUploadInspectionLabel not found!"); }

                const photoUploadWorkDoneLabel = document.getElementById('photoUploadWorkDone'); 
                if(photoUploadWorkDoneLabel) {
                    photoUploadWorkDoneLabel.addEventListener('dragover', (e) => { e.preventDefault(); photoUploadWorkDoneLabel.style.borderColor = '#2980b9'; photoUploadWorkDoneLabel.classList.add('bg-green-100'); }); 
                    photoUploadWorkDoneLabel.addEventListener('dragleave', () => { photoUploadWorkDoneLabel.style.borderColor = '#3498db'; photoUploadWorkDoneLabel.classList.remove('bg-green-100'); });
                    photoUploadWorkDoneLabel.addEventListener('drop', (e) => { e.preventDefault(); photoUploadWorkDoneLabel.style.borderColor = '#3498db'; photoUploadWorkDoneLabel.classList.remove('bg-green-100'); this.handlePhotoUpload('workDone', e); });
                } else { console.error("photoUploadWorkDoneLabel not found!"); }

                const addressInput = document.getElementById('address');
                if (addressInput) {
                    addressInput.addEventListener('input', (e) => {
                        const query = e.target.value;
                        const suggestionsDiv = document.getElementById('addressSuggestions');
                        if (!suggestionsDiv) return;
                        if (!query || query.length < 3) { suggestionsDiv.style.display = 'none'; return; }
                        fetchAddressSuggestions(query).then(suggestions => {
                            displayAddressSuggestions(suggestions);
                        });
                    });
                }
                
                document.addEventListener('click', (e) => {
                    const suggestionsBox = document.getElementById('addressSuggestions');
                    const target = e.target; 
                    if (suggestionsBox && target && typeof target.closest === 'function' && !target.closest('.form-group') && target.id !== 'address' && 
                        !(target.id === 'photoUploadInspection' || target.closest('#photoUploadInspection')) &&
                        !(target.id === 'photoUploadWorkDone' || target.closest('#photoUploadWorkDone')) ) { 
                        suggestionsBox.style.display = 'none';
                    }
                });

                const saveBtn = document.getElementById('saveBtn');
                if (saveBtn) {
                    saveBtn.addEventListener('click', () => { console.log("Save Button Clicked"); this.saveData(); });
                } else { console.error("Save Button (saveBtn) not found!"); }

                const previewBtn = document.getElementById('previewBtn');
                if (previewBtn) {
                    previewBtn.addEventListener('click', () => { console.log("Preview Button Clicked"); this.previewReport(); });
                } else { console.error("Preview Button (previewBtn) not found!"); }
                
                const generatePdfBtn = document.getElementById('generatePdfBtn');
                if (generatePdfBtn) {
                    generatePdfBtn.addEventListener('click', () => { console.log("Generate PDF Button Clicked"); this.generatePDF(); });
                } else { console.error("Generate PDF Button (generatePdfBtn) not found!"); }


                const modal = document.getElementById('reportModal');
                const closeBtn = modal ? modal.querySelector('.close') : null; 
                
                if(closeBtn && modal) {
                     closeBtn.addEventListener('click', () => { modal.style.display = 'none'; });
                } else { 
                    if (!modal) console.error("Report Modal (reportModal) not found!");
                    if (modal && !closeBtn) console.error("Modal close button not found!");
                }

                window.addEventListener('click', (e) => { if (modal && e.target === modal) { modal.style.display = 'none'; } });
                console.log("Event listeners setup complete.");
            }

            setDefaultDate() {
                const serviceDateEl = document.getElementById('serviceDate');
                if (serviceDateEl && !serviceDateEl.value) { const today = new Date().toISOString().split('T')[0]; serviceDateEl.value = today; }
            }

            handlePhotoUpload(type, e) { 
                console.log(`handlePhotoUpload called for type: ${type}. Event type: ${e.type}`);
                const files = (e.target && e.target.files) || (e.dataTransfer && e.dataTransfer.files);
                if (!files || files.length === 0) {
                    showMessage('No files selected or dropped.', 'info');
                    console.log('No files detected in handlePhotoUpload.');
                    return;
                }
                console.log(`Handling ${files.length} files for type: ${type}. Files object:`, files);
                if (files[0]) {
                    console.log(`First file details: name=${files[0].name}, size=${files[0].size}, type=${files[0].type}`);
                }
                
                const photoArray = type === 'inspection' ? this.inspectionPhotos : this.workDonePhotos;

                Array.from(files).forEach((file, index) => {
                    console.log(`Processing file ${index + 1} for ${type}: ${file.name}, type: ${file.type}, size: ${file.size}`);
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        
                        reader.onprogress = (event) => {
                            if (event.lengthComputable) {
                                const percentLoaded = Math.round((event.loaded / event.total) * 100);
                                console.log(`FileReader progress for ${file.name} (${type}): ${percentLoaded}%`);
                            }
                        };
                        
                        reader.onload = (event) => {
                            const fileDataUrl = event.target && event.target.result;
                            console.log(`FileReader onload for ${file.name} (${type}). Result type: ${typeof fileDataUrl}`);
                            if (typeof fileDataUrl === 'string' && fileDataUrl.startsWith('data:image/')) {
                                console.log(`File ${file.name} (${type}) read successfully. Data URL (first 60 chars): ${fileDataUrl.substring(0,60)}`);
                                photoArray.push({ name: file.name, data: fileDataUrl });
                                this.updatePhotoPreview(type); 
                            } else {
                                console.error(`File ${file.name} (${type}) did not produce a valid Data URL. Result (first 100 chars):`, fileDataUrl ? String(fileDataUrl).substring(0,100) : 'undefined', 'Full result:', (event.target && event.target.result));
                                showMessage(`Error processing file ${file.name}. Invalid data format.`, 'error');
                            }
                        };
                        reader.onerror = (errorEvent) => { 
                            const errorObj = errorEvent.target && errorEvent.target.error;
                            const errorCode = errorObj ? errorObj.code : 'N/A';
                            const errorMessage = errorObj ? errorObj.message : 'Unknown error';
                            console.error(`FileReader error for ${file.name} (${type}):`, errorEvent, errorObj, `Code: ${errorCode}`, `Message: ${errorMessage}`);
                            showMessage(`Critical error reading file ${file.name}. Code: ${errorCode}. Message: ${errorMessage}`, 'error');
                        };
                        reader.readAsDataURL(file);
                    } else {
                        console.warn(`File ${file.name} (${type}) is not an image. Type: ${file.type}`);
                        showMessage(`File ${file.name} is not an image and was skipped.`, 'warning');
                    }
                });
                if (e.target && e.target.type === 'file') e.target.value = null; 
            }

            updatePhotoPreview(type) { 
                const previewDivId = type === 'inspection' ? 'photoPreviewInspection' : 'photoPreviewWorkDone';
                const photoArray = type === 'inspection' ? this.inspectionPhotos : this.workDonePhotos;
                
                const preview = document.getElementById(previewDivId);
                if (!preview) { console.error(`${previewDivId} element not found!`); return; }
                preview.innerHTML = ''; 
                console.log(`Updating photo preview for ${type}. Number of photos: ${photoArray.length}`);

                photoArray.forEach((photo, index) => {
                    console.log(`Previewing photo ${index} for ${type}: ${photo.name}, Data starts with: ${photo.data ? String(photo.data).substring(0, 30) : 'No data'}`);
                    if (!photo.data || typeof photo.data !== 'string' || !photo.data.startsWith('data:image/')) {
                        console.error(`Invalid data for photo ${photo.name} in updatePhotoPreview (${type}).`);
                        const errorItem = document.createElement('div');
                        errorItem.className = 'photo-item shadow-md text-red-500 p-2 text-xs flex items-center justify-center';
                        errorItem.textContent = `Error: Invalid data for ${photo.name}`;
                        preview.appendChild(errorItem);
                        return; 
                    }
                    const photoItem = document.createElement('div');
                    photoItem.className = 'photo-item shadow-md';
                    const img = document.createElement('img'); 
                    img.src = photo.data; img.alt = photo.name;
                    img.onerror = () => {
                        console.error(`Image load error in preview for (${type}):`, photo.name, "Data attempted:", photo.data ? String(photo.data).substring(0,100) + "..." : "No data string");
                        photoItem.innerHTML = ''; 
                        const errorText = document.createElement('p');
                        errorText.className = 'text-red-500 text-xs p-1 text-center';
                        errorText.textContent = `Load error: ${photo.name}`;
                        photoItem.appendChild(errorText);
                    };
                    const removeButton = document.createElement('button'); 
                    removeButton.className = 'photo-remove'; removeButton.innerHTML = '<i class="fas fa-times"></i>'; removeButton.type = 'button'; 
                    removeButton.addEventListener('click', () => this.removePhoto(type, index));
                    photoItem.appendChild(img); photoItem.appendChild(removeButton);
                    preview.appendChild(photoItem);
                });
            }

            removePhoto(type, index) { 
                const photoArray = type === 'inspection' ? this.inspectionPhotos : this.workDonePhotos;
                photoArray.splice(index, 1); 
                this.updatePhotoPreview(type); 
            }

            async handleAddressInput(e) { 
                const query = e.target && e.target.value;
                const suggestionsDiv = document.getElementById('addressSuggestions');
                if (!suggestionsDiv) return;
                if (!query || query.length < 3) { suggestionsDiv.style.display = 'none'; return; }
                const suggestions = this.getCaliforniaAddressSuggestions(query); 
                this.displayAddressSuggestions(suggestions);
            }

            getCaliforniaAddressSuggestions(query) {
                console.log("Using placeholder address suggestions for query:", query);
                const californiaAddresses = [ 
                    '123 Main St, Los Angeles, CA 90210', '456 Oak Ave, San Francisco, CA 94102',
                    '789 Pine St, San Diego, CA 92101', '321 Elm Dr, Sacramento, CA 95814',
                    '1001 Hollywood Blvd, Los Angeles, CA 90028', '200 Market St, San Francisco, CA 94105'
                ];
                return californiaAddresses.filter(address => 
                    address.toLowerCase().includes(query.toLowerCase())
                ).slice(0, 5);
            }

            displayAddressSuggestions(suggestions) {
                const suggestionsDiv = document.getElementById('addressSuggestions');
                if (!suggestionsDiv) return; suggestionsDiv.innerHTML = '';
                if (suggestions.length === 0) { suggestionsDiv.style.display = 'none'; return; }
                suggestions.forEach(suggestion => {
                    const item = document.createElement('div'); item.className = 'address-suggestion'; item.textContent = suggestion;
                    item.addEventListener('click', () => { const input = document.getElementById('address'); if (input) input.value = suggestion; suggestionsDiv.style.display = 'none'; });
                    suggestionsDiv.appendChild(item);
                });
                suggestionsDiv.style.display = 'block';
            }

            async saveData() {
                console.log("saveData called.");
                if (!currentUserId) { showMessage('User not authenticated. Cannot save data.', 'error'); return; }
                if (!this.db) { showMessage('Database not initialized. Cannot save data.', 'error'); return; }
                const formData = this.getFormData();
                if (!formData.customerName || !formData.address || !formData.serviceDate) { showMessage('Please fill in required fields (Customer Name, Address, Service Date).', 'error'); return; }
                const reportDocRef = doc(this.db, "artifacts", appId, "users", currentUserId, "ductInspectionReports", "currentReport");
                try { await setDoc(reportDocRef, formData); showMessage('Data saved successfully to Firebase!', 'success'); } catch (error) {
                    console.error("Error saving data to Firestore: ", error); showMessage('Error saving data. Check console.', 'error');
                }
            }

            async loadSavedData() {
                console.log("loadSavedData called.");
                if (!currentUserId) { console.log("loadSavedData: No currentUserId, returning."); return; }
                if (!this.db) { console.warn("loadSavedData: Database not initialized, returning."); return; }
                const reportDocRef = doc(this.db, "artifacts", appId, "users", currentUserId, "ductInspectionReports", "currentReport");
                try {
                    const docSnap = await getDoc(reportDocRef);
                    if (docSnap.exists()) { const data = docSnap.data(); this.populateForm(data); showMessage('Data loaded successfully!', 'info'); } 
                    else { console.log("No saved data found."); }
                } catch (error) { console.error("Error loading data: ", error); showMessage('Error loading saved data.', 'error');}
            }

            populateForm(data) {
                console.log("Populating form with data:", data);
                Object.keys(data).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        if (element.type === 'checkbox') { element.checked = data[key]; } 
                        else if (key !== 'duration') { 
                            element.value = data[key]; 
                        }
                    }
                });
                const checklist = document.querySelectorAll('input[name="checklist"]');
                if (data.checklist && Array.isArray(data.checklist)) {
                    checklist.forEach(cb => { cb.checked = data.checklist.includes(cb.value); });
                }
                this.inspectionPhotos = (data.inspectionPhotos && Array.isArray(data.inspectionPhotos)) ? data.inspectionPhotos : [];
                this.workDonePhotos = (data.workDonePhotos && Array.isArray(data.workDonePhotos)) ? data.workDonePhotos : [];
                this.updatePhotoPreview('inspection');
                this.updatePhotoPreview('workDone');
                if(data.serviceDate) document.getElementById('serviceDate').value = data.serviceDate;
            }

            getFormData() {
                console.log("getFormData called.");
                const formData = {}; const form = document.getElementById('inspectionForm'); if (!form) return formData;
                const elements = form.querySelectorAll('input, select, textarea');
                elements.forEach(el => {
                    if (!el.id && !el.name) return; 
                    const key = el.id || el.name;
                    if (el.type === 'checkbox') {
                        if (el.name === 'checklist') { if (!formData.checklist) formData.checklist = []; if (el.checked) formData.checklist.push(el.value); } 
                        else { formData[key] = el.checked; }
                    } else if (el.type !== 'file' && el.id !== 'duration') { 
                         formData[key] = el.value; 
                    }
                });
                // Collect inspection checklist
                formData.inspectionChecklist = Array.from(form.querySelectorAll('input[name="inspectionChecklist"]:checked')).map(cb => cb.value);
                // Collect work performed checklist
                formData.workPerformedChecklist = Array.from(form.querySelectorAll('input[name="workPerformedChecklist"]:checked')).map(cb => cb.value);
                formData.inspectionPhotos = this.inspectionPhotos; 
                formData.workDonePhotos = this.workDonePhotos;
                return formData;
            }

            previewReport() {
                console.log("previewReport called.");
                const formData = this.getFormData();
                if (!formData.customerName || !formData.address || !formData.serviceDate) {
                    showMessage('Fill required fields (Customer, Address, Date) before previewing.', 'error'); return;
                }
                const reportContent = this.generateReportHTML(formData);
                const previewEl = document.getElementById('reportPreview');
                const modalEl = document.getElementById('reportModal');
                if(previewEl) previewEl.innerHTML = reportContent;
                if(modalEl) modalEl.style.display = 'block';
            }

            generateReportHTML(data) {
                console.log("generateReportHTML called.");
                const checkedItems = data.checklist || [];
                const checklistHTML = checkedItems.length > 0 
                    ? checkedItems.map(item => `<li><i class="fas fa-check-circle text-green-500 mr-2"></i>${item}</li>`).join('')
                    : '<li>No specific tasks selected for work phase.</li>';
                
                const inspectionPhotosHTML = (data.inspectionPhotos || []).map(p => {
                    if (p.data && typeof p.data === 'string' && p.data.startsWith('data:image/')) {
                        return `<img src="${p.data}" alt="${p.name}" class="rounded border shadow-sm m-1 max-w-[150px] h-auto">`;
                    } return `<p class="text-red-500 m-1">Error displaying: ${p.name}</p>`;
                }).join('');

                const workDonePhotosHTML = (data.workDonePhotos || []).map(p => {
                    if (p.data && typeof p.data === 'string' && p.data.startsWith('data:image/')) {
                        return `<img src="${p.data}" alt="${p.name}" class="rounded border shadow-sm m-1 max-w-[150px] h-auto">`;
                    } return `<p class="text-red-500 m-1">Error displaying: ${p.name}</p>`;
                }).join('');

                const logoUrlForPreview = "https://thebayservices.com/wp-content/uploads/2022/07/bay-services-logo.png";

                return `
                    <div class="report-content p-2 sm:p-4">
                        <div class="report-header text-center mb-4 pb-4 border-b">
                            <img src="${logoUrlForPreview}" alt="Bay Services Logo" class="report-logo-preview mx-auto" onerror="this.style.display='none'; console.error('Failed to load preview logo from URL.')">
                            <h1 class="report-title text-xl sm:text-2xl font-bold text-gray-800">INSPECTION & WORK REPORT</h1>
                            <p class="text-gray-600 text-sm sm:text-base"><strong>Date:</strong> ${data.serviceDate || 'N/A'}</p>
                        </div>
                        <div class="report-section mb-4">
                            <h3 class="text-base sm:text-lg font-semibold text-blue-600 mb-2">Customer & Service Information</h3>
                            <p class="text-sm sm:text-base"><strong>Name:</strong> ${data.customerName || 'N/A'}</p>
                            <p class="text-sm sm:text-base"><strong>Phone:</strong> ${data.phoneNumber || 'N/A'}</p>
                            <p class="text-sm sm:text-base"><strong>Email:</strong> ${data.email || 'N/A'}</p>
                            <p class="text-sm sm:text-base"><strong>Address:</strong> ${data.address || 'N/A'}</p>
                            <p class="text-sm sm:text-base"><strong>Service Type:</strong> ${data.serviceType || 'N/A'}</p>
                            <p class="text-sm sm:text-base"><strong>Technician:</strong> ${data.technician || 'N/A'}</p>
                        </div>
                        
                        <h2 class="report-phase-title">Phase 1: Pre-Service Inspection Report</h2>
                        <div class="report-section mb-4">
                            <h3 class="text-base sm:text-lg font-semibold text-blue-600 mb-2">Initial Observations & Findings</h3>
                            <div id="preInspectionChecklist" class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 mb-4">
                                <!-- Dynamic checklist will be populated here -->
                            </div>
                            <div class="mt-4">
                                <label for="otherObservations" class="form-label">Other observations (please specify):</label>
                                <textarea id="otherObservations" class="form-textarea" rows="2" placeholder="Enter any additional observations..."></textarea>
                            </div>
                        </div>
                        ${(data.inspectionPhotos && data.inspectionPhotos.length > 0) ? `
                        <div class="report-section mb-4">
                            <h3 class="text-base sm:text-lg font-semibold text-blue-600 mb-2">Inspection Photos</h3>
                            <div class="report-photos flex flex-wrap gap-2">${inspectionPhotosHTML}</div>
                        </div>` : ''}

                        <h2 class="report-phase-title">Phase 2: Work Done & Recommendations Report</h2>
                        <div class="report-section mb-4">
                            <h3 class="text-base sm:text-lg font-semibold text-blue-600 mb-2">Work Performed Checklist</h3>
                            <ul class="list-none pl-0 mb-2 text-sm sm:text-base">${checklistHTML}</ul>
                        </div>
                        ${data.workPerformed ? `
                        <div class="report-section mb-4">
                            <h3 class="text-base sm:text-lg font-semibold text-blue-600 mb-2">Additional Work Performed Details</h3>
                            <p class="whitespace-pre-wrap text-sm sm:text-base">${data.workPerformed}</p>
                        </div>` : ''}
                        ${data.recommendations ? `
                        <div class="report-section mb-4">
                            <h3 class="text-base sm:text-lg font-semibold text-blue-600 mb-2">Recommendations for Customer</h3>
                            <p class="whitespace-pre-wrap text-sm sm:text-base">${data.recommendations}</p>
                        </div>` : ''}
                        ${(data.workDonePhotos && data.workDonePhotos.length > 0) ? `
                        <div class="report-section mb-4">
                            <h3 class="text-base sm:text-lg font-semibold text-blue-600 mb-2">Work Done Photos</h3>
                            <div class="report-photos flex flex-wrap gap-2">${workDonePhotosHTML}</div>
                        </div>` : ''}

                        <div class="report-section mt-6 pt-4 border-t">
                            <h3 class="text-base sm:text-lg font-semibold text-blue-600 mb-2">Service Completion</h3>
                            <p class="text-sm sm:text-base">This report certifies that the above services have been completed by Bay Services on ${data.serviceDate || 'the specified date'}.</p><br>
                            <p class="text-sm sm:text-base"><strong>Technician Signature:</strong> ${data.technician || '_________________'}</p>
                            <p class="mt-1 text-sm sm:text-base"><strong>Customer Signature:</strong> _________________</p>
                        </div>
                    </div>`;
            }
            
            async generatePDF() {
                console.log("generatePDF called.");
                const formData = this.getFormData();
                if (!formData.customerName || !formData.address || !formData.serviceDate) {
                    showMessage('Fill required fields before PDF generation.', 'error'); return;
                }

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // Constants for layout
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const leftMargin = 20;
                const rightMargin = 20;
                const contentWidth = pageWidth - leftMargin - rightMargin;
                const topMargin = 30;
                const bottomMargin = 30;
                
                // Font sizes
                const titleFontSize = 18;
                const subtitleFontSize = 14;
                const headerFontSize = 12;
                const bodyFontSize = 10;
                const smallFontSize = 8;

                // Colors
                const primaryColor = [59, 130, 246]; // Blue-600
                const secondaryColor = [107, 114, 128]; // Gray-500
                const accentColor = [147, 197, 253]; // Blue-300
                const boxBgColor = [249, 250, 251]; // Gray-50
                const boxBorderColor = [229, 231, 235]; // Gray-200

                // Logo dimensions
                const logoWidth = 60;
                const logoHeight = 20;
                const logoDataUrl = "data:image/png;base64,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";

                // Helper functions
                const addLogo = (yPosition) => {
                    try {
                        pdf.addImage(logoDataUrl, 'PNG', (pageWidth - logoWidth) / 2, yPosition, logoWidth, logoHeight);
                        return yPosition + logoHeight + 10;
                    } catch (e) {
                        console.error("Error adding logo:", e);
                        return yPosition;
                    }
                };

                const addHeader = (text, yPosition, fontSize = titleFontSize) => {
                    pdf.setFontSize(fontSize + 2);
                    pdf.setFont(undefined, 'bold');
                    pdf.setTextColor(...primaryColor);
                    pdf.text(text, pageWidth / 2, yPosition, { align: 'center' });
                    pdf.setFont(undefined, 'normal');
                    return yPosition + (fontSize * 0.5);
                };

                const addSubHeader = (text, yPosition) => {
                    pdf.setFontSize(subtitleFontSize);
                    pdf.setTextColor(...secondaryColor);
                    pdf.text(text, pageWidth / 2, yPosition, { align: 'center' });
                    return yPosition + (subtitleFontSize * 0.4);
                };

                const addBoxedSection = (title, content, yPosition, options = {}) => {
                    const padding = options.padding || 10;
                    const margin = options.margin || 10;
                    const boxWidth = contentWidth;
                    let contentHeight = 0;
                    pdf.setFontSize(bodyFontSize);
                    const splitContent = pdf.splitTextToSize(content, boxWidth - (padding * 2));
                    contentHeight = splitContent.length * (bodyFontSize * 0.5);
                    pdf.setFillColor(245, 247, 252);
                    pdf.setDrawColor(180, 190, 210);
                    pdf.roundedRect(leftMargin, yPosition, boxWidth, contentHeight + (padding * 2) + headerFontSize, 5, 5, 'FD');
                    pdf.setFontSize(headerFontSize + 1);
                    pdf.setTextColor(...primaryColor);
                    pdf.setFont(undefined, 'bold');
                    pdf.text(title, leftMargin + padding, yPosition + padding + (headerFontSize * 0.45));
                    pdf.setFontSize(bodyFontSize + 1);
                    pdf.setFont(undefined, 'normal');
                    pdf.setTextColor(30, 30, 30);
                    pdf.text(splitContent, leftMargin + padding, yPosition + padding + headerFontSize + 7);
                    return yPosition + contentHeight + (padding * 2) + headerFontSize + margin;
                };

                const addChecklistBox = (title, items, yPosition) => {
                    const padding = 8;
                    const margin = 8;
                    const boxWidth = contentWidth;
                    let contentHeight = 0;
                    
                    // Calculate content height
                    pdf.setFontSize(bodyFontSize);
                    const itemHeight = bodyFontSize * 0.5;
                    contentHeight = Math.max(1, items.length) * itemHeight;

                    // Draw box
                    pdf.setFillColor(...boxBgColor);
                    pdf.setDrawColor(...boxBorderColor);
                    pdf.roundedRect(leftMargin, yPosition, boxWidth, contentHeight + (padding * 2) + headerFontSize, 3, 3, 'FD');

                    // Add title
                    pdf.setFontSize(headerFontSize + 1);
                    pdf.setTextColor(...primaryColor);
                    pdf.setFont(undefined, 'bold');
                    pdf.text(title, leftMargin + padding, yPosition + padding + (headerFontSize * 0.45));

                    // Add items
                    pdf.setFontSize(bodyFontSize);
                    pdf.setFont(undefined, 'normal');
                    pdf.setTextColor(0, 0, 0);
                    if (items.length === 0) {
                        pdf.text('No items selected.', leftMargin + padding, yPosition + padding + headerFontSize + 7);
                    } else {
                        items.forEach((item, index) => {
                            pdf.text(`• ${item}`, leftMargin + padding, yPosition + padding + headerFontSize + 7 + (index * itemHeight));
                        });
                    }

                    return yPosition + contentHeight + (padding * 2) + headerFontSize + margin;
                };

                const addPhotoBox = (title, photos, yPosition, maxHeight) => {
                    const padding = 10;
                    const margin = 10;
                    const boxWidth = contentWidth;
                    // Calculate max photo size to fit all photos in the available height
                    let photoSize = 40;
                    let photosPerRow = Math.floor((boxWidth - (padding * 2)) / (photoSize + 10));
                    let rows = Math.ceil(photos.length / photosPerRow);
                    let boxHeight = (rows * (photoSize + 10)) + (padding * 2) + headerFontSize + 10;
                    // If too tall, shrink photo size
                    if (maxHeight && boxHeight > maxHeight) {
                        rows = Math.ceil(photos.length / photosPerRow);
                        photoSize = Math.floor((maxHeight - (padding * 2) - headerFontSize - 10) / rows) - 10;
                        photosPerRow = Math.floor((boxWidth - (padding * 2)) / (photoSize + 10));
                        rows = Math.ceil(photos.length / photosPerRow);
                        boxHeight = (rows * (photoSize + 10)) + (padding * 2) + headerFontSize + 10;
                    }
                    // Draw box
                    pdf.setFillColor(245, 247, 252);
                    pdf.setDrawColor(180, 190, 210);
                    pdf.roundedRect(leftMargin, yPosition, boxWidth, boxHeight, 5, 5, 'FD');
                    // Add title (no emoji)
                    pdf.setFontSize(headerFontSize + 1);
                    pdf.setTextColor(...primaryColor);
                    pdf.setFont(undefined, 'bold');
                    pdf.text(title, leftMargin + padding, yPosition + padding + (headerFontSize * 0.45));
                    // Add photos in grid
                    let currentX = leftMargin + padding;
                    let currentY = yPosition + padding + headerFontSize + 10;
                    let rowPhotoCount = 0;
                    photos.forEach((photo, index) => {
                        if (rowPhotoCount === photosPerRow) {
                            currentX = leftMargin + padding;
                            currentY += photoSize + 10;
                            rowPhotoCount = 0;
                        }
                        pdf.setDrawColor(200, 200, 200);
                        pdf.setLineWidth(0.5);
                        pdf.rect(currentX - 2, currentY - 2, photoSize + 4, photoSize + 4, 'S');
                        try {
                            pdf.addImage(
                                photo.data,
                                'JPEG',
                                currentX,
                                currentY,
                                photoSize,
                                photoSize
                            );
                        } catch (e) {
                            console.error("Error adding photo:", e);
                        }
                        currentX += photoSize + 10;
                        rowPhotoCount++;
                    });
                    return yPosition + boxHeight + margin;
                };

                const addFooter = (pageNumber, totalPages) => {
                    const footerY = pageHeight - 15;
                    pdf.setFontSize(smallFontSize);
                    pdf.setTextColor(...secondaryColor);
                    pdf.text(`Page ${pageNumber} of ${totalPages}`, pageWidth / 2, footerY, { align: 'center' });
                    pdf.text("www.thebayservices.com", pageWidth / 2, footerY + 5, { align: 'center' });
                };

                // --- PHASE 1: INSPECTION (Page 1) ---
                let yPosition = topMargin;
                yPosition = addLogo(yPosition);
                yPosition = addHeader("INSPECTION & WORK REPORT", yPosition);
                yPosition = addSubHeader(`Service Date: ${formData.serviceDate}`, yPosition);
                // Divider
                pdf.setDrawColor(200, 210, 230);
                pdf.setLineWidth(0.7);
                pdf.line(leftMargin, yPosition + 2, pageWidth - rightMargin, yPosition + 2);
                yPosition += 8;
                // Customer Info Box
                // ... customer info code ...
                // Section separation
                yPosition += 5;
                yPosition = addHeader("PHASE 1: PRE-SERVICE INSPECTION", yPosition, headerFontSize + 4);
                yPosition += 5;
                // Inspection Checklist Box
                const inspectionChecklistItems = formData.inspectionChecklist || [];
                yPosition = addChecklistBox("Initial Observations & Findings", inspectionChecklistItems, yPosition);
                // Inspection Photos Box (fit to remaining space)
                if (this.inspectionPhotos && this.inspectionPhotos.length > 0) {
                    yPosition += 5;
                    const maxPhotoBoxHeight = pageHeight - bottomMargin - yPosition - 20;
                    yPosition = addPhotoBox("Inspection Photos", this.inspectionPhotos, yPosition, maxPhotoBoxHeight);
                }
                addFooter(1, 2);
                // --- PHASE 2: WORK DONE (Page 2) ---
                pdf.addPage();
                yPosition = topMargin;
                yPosition = addLogo(yPosition);
                yPosition = addHeader("PHASE 2: WORK DONE & RECOMMENDATIONS", yPosition, headerFontSize + 4);
                yPosition += 10;
                // Work Performed Checklist Box
                const workChecklistItems = formData.workPerformedChecklist || [];
                yPosition = addChecklistBox("Work Performed", workChecklistItems, yPosition);
                // Additional Work Details Box
                if (formData.workPerformed) {
                    yPosition += 5;
                    yPosition = addBoxedSection("Additional Work Details", formData.workPerformed, yPosition);
                }
                // Recommendations Box
                if (formData.recommendations) {
                    yPosition += 5;
                    yPosition = addBoxedSection("Recommendations", formData.recommendations, yPosition);
                }
                // Work Done Photos Box (fit to remaining space)
                if (this.workDonePhotos && this.workDonePhotos.length > 0) {
                    yPosition += 5;
                    const maxPhotoBoxHeight = pageHeight - bottomMargin - yPosition - 20;
                    yPosition = addPhotoBox("Work Done Photos", this.workDonePhotos, yPosition, maxPhotoBoxHeight);
                }
                // Service Completion Box
                yPosition += 5;
                const completionContent = [
                    `This report certifies that the above services have been completed by Bay Services on ${formData.serviceDate}.`,
                    `Technician Signature: ${formData.technician || '_________________________'}`,
                    `Customer Signature: _________________________`
                ].join('\n');
                yPosition = addBoxedSection("Service Completion", completionContent, yPosition);
                addFooter(2, 2);
                // Save the PDF
                pdf.save(`BayServices_Report_${formData.customerName.replace(/\s+/g, '_')}_${formData.serviceDate}.pdf`);
                showMessage('PDF generated successfully!', 'success');
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded and parsed.");
            const indicator = document.getElementById('javascript-running-indicator');
            if(indicator) indicator.style.display = 'none';
            
            if (db && auth) { // Ensure Firebase services are initialized
                if (!appInstance) { 
                    console.log("Creating App instance in DOMContentLoaded (db and auth available).");
                    appInstance = new DuctInspectionApp(db);
                    appInstance.init(); 
                }
                // Attempt initial sign-in after app instance is ready
                attemptSignIn().catch(error => { 
                    console.error("Error during initial sign-in attempt from DOMContentLoaded:", error);
                    showMessage("Sign-in attempt failed: " + (error.message || "Unknown error"), "error");
                });
            } else {
                console.error("DOMContentLoaded: Firebase db or auth is not initialized. App instance NOT created. Firebase init likely failed.");
                // Alert should have been shown by Firebase init catch block.
                // Add an extra alert here just in case.
                alert("CRITICAL: App cannot start because Firebase connection failed. Please check configuration and network.");
            }
        });

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }

        async function fetchAddressSuggestions(query) {
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=us&limit=5`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                return data.map(item => item.display_name);
            } catch (error) {
                console.error('Error fetching address suggestions:', error);
                return [];
            }
        }

        function displayAddressSuggestions(suggestions) {
            const suggestionsDiv = document.getElementById('addressSuggestions');
            if (!suggestionsDiv) return; suggestionsDiv.innerHTML = '';
            if (suggestions.length === 0) { suggestionsDiv.style.display = 'none'; return; }
            suggestions.forEach(suggestion => {
                const item = document.createElement('div'); item.className = 'address-suggestion'; item.textContent = suggestion;
                item.addEventListener('click', () => { const input = document.getElementById('address'); if (input) input.value = suggestion; suggestionsDiv.style.display = 'none'; });
                suggestionsDiv.appendChild(item);
            });
            suggestionsDiv.style.display = 'block';
        }

        const inspectionChecklists = {
            "Air Duct Cleaning": [
                "Access to vents and registers: Clear",
                "Access to vents and registers: Restricted (specify reason)",
                "Access to HVAC unit (furnace/AC): Clear",
                "Access to HVAC unit (furnace/AC): Restricted (specify reason)",
                "Pets secured",
                "Fragile items secured/removed",
                "Thermostat turned off",
                "Customer's specific concerns/issues noted",
                "Condition of vent registers and grilles",
                "Visible dust/debris at vent openings/registers",
                "Visible signs of mold at vent openings/registers",
                "Unusual odors from vents",
                "Restricted airflow in certain rooms/zones",
                "Condition of visible ductwork",
                "Condition of plenum (supply/return)",
                "Air filter condition",
                "Air filter type and size noted",
                "Blower compartment: Dirty",
                "Blower wheel: Dirty",
                "A/C coil: Dirty (if accessible)",
                "Condensate drain pan condition",
                "HVAC unit general condition",
                "Evidence of prior duct cleaning"
            ],
            "Dryer Vent Cleaning SIDE-BY-SIDE": [
                "Dryer location and accessibility for movement (Side-by-Side)",
                "Dryer disconnected from power/gas before inspection",
                "Lint screen condition",
                "Lint trap area condition",
                "Vent connection (dryer to wall) type and condition",
                "Vent connection (dryer to wall) security",
                "Visible lint/blockage in transition duct",
                "Approximate duct run length and complexity",
                "Exterior vent cover type and condition",
                "Airflow at exterior vent",
                "Signs of moisture damage around vent path or outlet",
                "Customer reports of previous issues",
                "Signs of pest activity at vent outlet"
            ],
            "Dryer Vent Cleaning STACKED": [
                "Dryer location and accessibility (Stacked)",
                "Dryer disconnected from power/gas before inspection",
                "Lint screen condition",
                "Lint trap area condition",
                "Vent connection (dryer to wall) type and condition",
                "Vent connection (dryer to wall) security",
                "Visible lint/blockage in accessible part of transition duct",
                "Approximate duct run length and complexity",
                "Exterior vent cover type and condition",
                "Airflow at exterior vent",
                "Signs of moisture damage around vent path or outlet",
                "Customer reports of previous issues",
                "Signs of pest activity at vent outlet",
                "Presence/absence of access panels for vent ducting"
            ],
            "Chimney Sweep": [
                "Access to fireplace/appliance: Clear",
                "Access to fireplace/appliance: Restricted",
                "Area around hearth protected",
                "Customer's specific concerns/issues noted",
                "Exterior chimney structure condition",
                "Chimney cap/spark arrester: Condition and presence",
                "Chimney crown condition",
                "Flashing condition",
                "Obstructions at top of chimney",
                "Stains/efflorescence on exterior chimney surface",
                "Interior firebox condition",
                "Damper operation and condition",
                "Lintel condition",
                "Smoke chamber condition",
                "Visible obstructions in flue",
                "Creosote/soot buildup in flue",
                "Flue liner: Type and condition",
                "Appliance connector pipe condition",
                "Clearance to combustibles maintained",
                "Smoke/CO detectors: Presence and functionality"
            ],
            "Furnace Cleaning with Blower": [
                "Access to furnace: Clear",
                "Access to furnace: Restricted",
                "Furnace power/gas off before inspection",
                "Thermostat condition and settings",
                "Customer's specific concerns/issues noted",
                "Air filter: Condition, type, and size",
                "Blower compartment condition",
                "Blower wheel condition",
                "Blower motor condition/lubrication",
                "Blower belt condition and tension",
                "Burner compartment condition",
                "Burners condition",
                "Ignition system: Type and condition",
                "Flame sensor condition",
                "Heat exchanger: Visible condition",
                "Condensate drain system condition",
                "Venting system/flue pipe condition",
                "Safety switches/limit controls: Visible condition",
                "Electrical wiring and connections condition",
                "Gas valve and connections condition",
                "Furnace general cleanliness",
                "Unusual noises or odors during furnace operation"
            ],
            "Kitchen Range Hood Cleaning": [
                "Access to hood: Clear",
                "Access to hood: Restricted",
                "Surrounding area and equipment protected",
                "Customer's specific concerns/issues noted",
                "System power off",
                "Hood type and size",
                "Grease buildup on interior hood surfaces",
                "Hood exterior surfaces condition",
                "Filter type and number",
                "Grease buildup on filters",
                "Filters condition",
                "Grease cups/trays: Condition and fullness",
                "Visible grease buildup in accessible ductwork sections",
                "Ductwork access panels: Availability and condition",
                "Signs of grease leakage at ductwork seams and connections",
                "Exhaust fan: Location and accessibility",
                "Grease buildup on fan housing",
                "Grease buildup on fan blades",
                "Fan motor condition/noise",
                "Fan belt condition and tension",
                "Fan bearings condition",
                "Fan electrical connections condition",
                "Fire suppression system present",
                "Fire suppression nozzles: Condition",
                "Fire suppression fusible links: Condition",
                "Fire suppression system inspection tag: Date",
                "Makeup air system observed",
                "Hood lighting condition",
                "Evidence and standard of previous cleaning"
            ]
        };

        function updateInspectionChecklist(serviceType) {
            const checklistContainer = document.getElementById('preInspectionChecklist');
            if (!checklistContainer) return;

            checklistContainer.innerHTML = '';
            const checklist = inspectionChecklists[serviceType] || [];

            checklist.forEach(item => {
                const div = document.createElement('div');
                div.className = 'checkbox-label';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = 'inspectionChecklist';
                checkbox.value = item;
                checkbox.className = 'form-checkbox rounded text-blue-500 mr-2 focus:ring-blue-500';
                
                const label = document.createElement('label');
                label.textContent = item;
                
                div.appendChild(checkbox);
                div.appendChild(label);
                checklistContainer.appendChild(div);
            });
        }

        // Add event listener for service type change
        document.getElementById('serviceType').addEventListener('change', (e) => {
            updateInspectionChecklist(e.target.value);
        });

        // Initialize checklist on page load
        document.addEventListener('DOMContentLoaded', () => {
            const serviceType = document.getElementById('serviceType').value;
            updateInspectionChecklist(serviceType);
        });

        const workPerformedChecklists = {
            "Air Duct Cleaning": [
                "Protected vents and household items",
                "System placed under negative pressure",
                "Supply ducts cleaned (e.g., using whip system, brush system, air scrubbing)",
                "Return ducts cleaned",
                "Accessible plenum(s) cleaned",
                "Blower motor and housing cleaned",
                "Evaporator coil cleaned (if accessible and included in service)",
                "Condensate pan cleaned (if accessible and included in service)",
                "Registers and grilles cleaned",
                "Air filter checked/replaced/cleaned (as per agreement)",
                "Access holes sealed (if created)",
                "System tested for proper operation post-cleaning",
                "Work area cleaned up"
            ],
            "Dryer Vent Cleaning SIDE-BY-SIDE": [
                "Dryer (Side-by-Side) moved and work area prepared",
                "Lint screen cleaned",
                "Lint trap housing cleaned/vacuumed",
                "Transition duct (from dryer to wall) cleaned/replaced (if needed)",
                "Main dryer vent duct cleaned (e.g., using brushes, air tools from one or both ends)",
                "Exterior vent cover cleaned and checked for proper operation",
                "Airflow tested post-cleaning",
                "Dryer reconnected and tested (if applicable)",
                "Work area cleaned up"
            ],
            "Dryer Vent Cleaning STACKED": [
                "Access to stacked dryer ensured, work area prepared",
                "Lint screen cleaned",
                "Lint trap housing cleaned/vacuumed",
                "Transition duct (from dryer to wall) cleaned/replaced (if needed)",
                "Main dryer vent duct cleaned (e.g., using brushes, air tools from one or both ends)",
                "Exterior vent cover cleaned and checked for proper operation",
                "Airflow tested post-cleaning",
                "Dryer reconnected and tested (if applicable)",
                "Work area cleaned up"
            ],
            "Chimney Sweep": [
                "Work area protected (drop cloths, etc.)",
                "Detailed inspection performed before cleaning",
                "Flue swept (e.g., using brushes, rods, power sweeping system)",
                "Smoke chamber cleaned",
                "Damper area cleaned and checked",
                "Firebox cleaned",
                "Creosote and debris removed from system",
                "Ash dump cleaned (if applicable)",
                "Visual inspection of liner post-cleaning",
                "Chimney cap/spark arrester checked/cleaned",
                "Work area cleaned up",
                "Basic operational check performed (e.g., damper movement)"
            ],
            "Furnace Cleaning with Blower": [
                "Safety checks performed before starting",
                "Furnace exterior wiped down",
                "Blower compartment cleaned",
                "Blower wheel and motor cleaned",
                "Burner assembly cleaned",
                "Ignition system (pilot, HSI, electrode) cleaned and inspected",
                "Flame sensor cleaned",
                "Accessible heat exchanger surfaces brushed/vacuumed",
                "Condensate trap and drain line cleaned/flushed (for high-efficiency furnaces)",
                "Flue passages/vent pipe checked and cleaned if necessary",
                "Air filter replaced/cleaned (as per agreement)",
                "Furnace panels secured",
                "System operation tested (ignition, flame characteristics, blower operation)",
                "Safety controls checked (e.g., limit switch, rollout switch – if part of service)",
                "Work area cleaned up"
            ],
            "Kitchen Range Hood Cleaning": [
                "Appliances and surfaces protected",
                "Hood filters removed and cleaned (e.g., soaked, pressure washed)",
                "Grease traps/cups emptied and cleaned",
                "Interior and exterior surfaces of hood canopy cleaned/degreased",
                "Accessible ductwork cleaned (from hood to fan, or sections between access panels)",
                "Exhaust fan housing and blades scraped/cleaned/degreased",
                "Fan belt checked/adjusted/replaced (if applicable and included)",
                "Access panels opened and resealed",
                "Fire suppression system components (nozzles, links) carefully cleaned around (if present and cleaning around them is part of scope)",
                "Work area cleaned up, equipment polished",
                "System tested for proper operation"
            ]
        };

        function updateWorkPerformedChecklist(serviceType) {
            const checklistContainer = document.getElementById('workPerformedChecklist');
            if (!checklistContainer) return;

            checklistContainer.innerHTML = '';
            const checklist = workPerformedChecklists[serviceType] || [];

            checklist.forEach(item => {
                const div = document.createElement('div');
                div.className = 'checkbox-label';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = 'workPerformedChecklist';
                checkbox.value = item;
                checkbox.className = 'form-checkbox rounded text-blue-500 mr-2 focus:ring-blue-500';
                
                const label = document.createElement('label');
                label.textContent = item;
                
                div.appendChild(checkbox);
                div.appendChild(label);
                checklistContainer.appendChild(div);
            });
        }

        // Add event listener for service type change
        document.getElementById('serviceType').addEventListener('change', (e) => {
            updateWorkPerformedChecklist(e.target.value);
        });

        // Initialize work performed checklist on page load
        document.addEventListener('DOMContentLoaded', () => {
            const serviceType = document.getElementById('serviceType').value;
            updateWorkPerformedChecklist(serviceType);
        });

    </script>
</body>
</html>